<% provide(:title, t(".title")) %>

<div class="container">
  <h1><%= yield(:title) %></h1>

  <div id="results-selector" class="results-select form-inline">
    <%= render 'results_selector', show_records_options: true %>
  </div>

  <% record_params = params.permit(:event_id, :region, :years, :show).to_hash.values %>
  <% record_timestamp = Timestamp.find_by(name: "compute_auxiliary_data_end") %>
  <% cache_if record_timestamp.present?, ["records", *record_params, record_timestamp&.date, I18n.locale] do %>
    <%
      # @rows = ActiveRecord::Base.connection.exec_query(@query)
      @rows = @results_rows
    %>

    <div id="search-results" class="results">
      <div id="results-list">
        <% if @record_view.mixed? %>
          <% @rows.group_by(&:eventId).each do |event_id, rows| %>
            <% event = Event.c_find(event_id) %>
            <h2>
              <%= link_to rankings_path(event.id, "single"), class: "plain" do %>
                <%= cubing_icon event.id %>
                <%= event.name %>
              <% end %>
            </h2>
            <%= render 'records_mixed_table', rows: rows %>
          <% end %>
        <% elsif @record_view.slim? || @record_view.separate? %>
          <% slim_rows, single_rows, average_rows = compute_slim_or_separate_records(@rows) %>
          <% if @record_view.slim? %>
            <%= render 'records_slim_table', rows: slim_rows %>
          <% else %>
            <h2> <%= t("results.table_elements.type_options.single") %> </h2>
            <%= render 'records_separate_table', rows: single_rows, type: "single" %>

            <h2> <%= t("results.table_elements.type_options.average") %> </h2>
            <%= render 'records_separate_table', rows: average_rows, type: "average" %>
          <% end %>
        <% elsif @record_view.history? %>
          <% @rows.group_by(&:eventId).each do |event_id, rows| %>
            <% event = Event.c_find(event_id) %>
            <h2>
              <%= link_to rankings_path(event.id, "single"), class: "plain" do %>
                <%= cubing_icon event.id %>
                <%= event.name %>
              <% end %>
            </h2>
            <%= render 'records_histories_table', rows: rows %>
          <% end %>
        <% elsif @record_view.mixed_history? %>
          <%= render 'records_histories_table', rows: @rows %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
